<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>思辨场</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ==================== 变量定义 ==================== */
    :root {
      --bg: #f2f2f2;
      --panel: rgba(255, 255, 255, 0.88);
      --card: rgba(255, 255, 255, 0.96);
      --ink: #111111;
      --muted: #666666;
      --line: #d0d0d0;
      --shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
      --sans: "Manrope", "PingFang SC", sans-serif;
      --mono: "JetBrains Mono", monospace;
      --bg-image: none;
    }

    /* ==================== 基础样式 ==================== */
    * { box-sizing: border-box; margin: 0; padding: 0; border-radius: 0 !important; }
    html { scroll-behavior: smooth; }

    body {
      font-family: var(--sans);
      color: var(--ink);
      background:
        radial-gradient(980px 460px at 50% -110px, rgba(0, 0, 0, 0.05), transparent 70%),
        radial-gradient(980px 360px at 52% 110%, rgba(0, 0, 0, 0.04), transparent 68%),
        linear-gradient(180deg, #fafafa 0%, #f1f1f1 100%);
      min-height: 100vh;
      padding: 24px 16px 34px;
      isolation: isolate;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: var(--bg-image);
      background-size: cover;
      background-position: center;
      opacity: 0.3;
      pointer-events: none;
      z-index: -1;
    }

    .app { max-width: 1180px; margin: 0 auto; display: grid; gap: 14px; }

    /* ==================== 布局组件 ==================== */
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      border-bottom: 1px solid rgba(193, 208, 236, 0.55);
      padding: 8px 16px;
      max-width: 1180px;
      margin: 0 auto;
      width: 100%;
    }

    .title {
      font-size: clamp(22px, 2.8vw, 32px);
      letter-spacing: -0.02em;
      font-weight: 700;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .section-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    h2 {
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #666666;
      font-weight: 700;
    }

    .mono {
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
    }

    /* ==================== 表单组件 ==================== */
    textarea {
      width: 100%;
      min-height: 122px;
      border: 1px solid var(--line);
      padding: 13px 14px;
      font-size: 15px;
      line-height: 1.62;
      font-family: var(--sans);
      outline: none;
      resize: vertical;
      background: var(--card);
      transition: border-color 180ms ease, box-shadow 180ms ease;
    }

    textarea:focus {
      border-color: #888888;
      box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.08);
    }

    input[type="search"] {
      flex: 1;
      border: 1px solid var(--line);
      min-height: 36px;
      padding: 0 12px;
      background: var(--card);
      font-size: 13px;
      outline: none;
    }

    input[type="search"]:focus {
      border-color: #888888;
      box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.08);
    }

    /* ==================== 按钮组件 ==================== */
    button {
      border: 1px solid #111111;
      background: var(--ink);
      color: #ffffff;
      padding: 0 14px;
      min-height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-family: var(--sans);
      font-weight: 600;
      transition: transform 150ms ease, background 150ms ease;
      box-shadow: 0 8px 16px rgba(87, 84, 232, 0.2);
    }

    button:hover { transform: translateY(-1px); background: #000000; }
    button:disabled { opacity: 0.58; cursor: not-allowed; }

    .btn-ghost {
      color: #222222;
      background: #ffffff;
      border-color: #cfcfcf;
      box-shadow: none;
    }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    /* ==================== 模型选择器 ==================== */
    .model-filter { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    .filter-btn {
      min-height: 32px;
      padding: 0 12px;
      border: 1px solid #cfcfcf;
      background: #fff;
      color: #222222;
      box-shadow: none;
      font-size: 13px;
    }

    .filter-btn.active {
      border-color: #111111;
      background: #111111;
      color: #fff;
    }

    .model-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
    }

    .model-item {
      border: 1px solid var(--line);
      min-height: 56px;
      padding: 8px 12px;
      background: var(--card);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
      cursor: pointer;
      transition: border-color 140ms ease, box-shadow 140ms ease;
    }

    .model-item:hover { border-color: #999999; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06); }

    .model-check {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 1px solid #a8a8a8;
      background: #ffffff;
      display: inline-grid;
      place-content: center;
      cursor: pointer;
    }

    .model-check::after {
      content: "";
      width: 10px;
      height: 10px;
      transform: scale(0);
      transition: transform 120ms ease;
      background: #ffffff;
      clip-path: polygon(14% 53%, 0 66%, 40% 100%, 100% 24%, 86% 11%, 39% 70%);
    }

    .model-check:checked { background: var(--ink); border-color: var(--ink); }
    .model-check:checked::after { transform: scale(1); }
    .model-name { font-weight: 600; font-size: 16px; }

    /* ==================== 响应卡片 ==================== */
    .response-row {
      height: clamp(460px, 68vh, 760px);
      display: flex;
      gap: 10px;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x proximity;
      padding-bottom: 2px;
    }

    .response-row::-webkit-scrollbar,
    .resp-body::-webkit-scrollbar { width: 8px; height: 8px; }

    .response-row::-webkit-scrollbar-thumb,
    .resp-body::-webkit-scrollbar-thumb { background: #b0b0b0; }

    .resp-card {
      width: clamp(340px, 36vw, 460px);
      flex: 0 0 auto;
      scroll-snap-align: start;
      border: 1px solid var(--line);
      background: var(--card);
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px;
      overflow: hidden;
    }

    .resp-head {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }

    .resp-tools { display: flex; gap: 6px; align-items: center; }

    .resp-title { font-size: 17px; font-weight: 700; }

    .order-btn {
      border: 1px solid #d0d0d0;
      background: #f7f7f7;
      color: var(--ink);
      width: 26px;
      height: 26px;
      padding: 0;
      font-size: 13px;
      font-weight: 700;
      box-shadow: none;
    }

    .order-btn:hover { transform: none; border-color: #999999; background: #ededed; }

    .copy-btn {
      border: 1px solid #111111;
      background: #111111;
      color: #fff;
      min-width: 52px;
      height: 24px;
      padding: 0 10px;
      font-size: 11px;
      box-shadow: none;
    }

    .copy-btn:hover { transform: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .copy-btn.copied { background: #22c55e; border-color: #22c55e; }

    .status {
      font-size: 12px;
      border: 1px solid #d0d0d0;
      padding: 3px 8px;
      color: var(--muted);
      font-family: var(--mono);
      background: #f7f7f7;
    }

    .resp-body {
      min-height: 0;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.72;
      font-size: 14px;
      padding-right: 2px;
    }

    /* ==================== 摘要面板 ==================== */
    .summary-panel {
      display: none;
      gap: 10px;
      border-top: 1px solid var(--line);
      padding-top: 10px;
    }

    .summary-card {
      border: 1px solid var(--line);
      background: var(--card);
      padding: 10px 12px;
      display: grid;
      grid-template-rows: auto minmax(0, 1fr);
      gap: 8px;
      min-height: 180px;
    }

    .summary-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .summary-title {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #666666;
      font-weight: 700;
    }

    .mini-btn { min-height: 28px; padding: 0 10px; font-size: 12px; }

    /* ==================== 历史记录 ==================== */
    .history-list {
      display: grid;
      gap: 8px;
      max-height: 300px;
      overflow: auto;
      padding-right: 2px;
    }

    .history-item {
      border: 1px solid var(--line);
      background: var(--card);
      padding: 8px 9px;
      display: grid;
      gap: 3px;
      cursor: pointer;
      transition: border-color 140ms ease;
    }

    .history-item:hover { border-color: #999999; }

    .history-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .history-item .time { color: var(--muted); font-family: var(--mono); font-size: 11px; }
    .history-item .question { font-weight: 600; font-size: 13px; line-height: 1.45; }

    .history-del {
      border: 1px solid #cfcfcf;
      background: #f6f6f6;
      color: var(--muted);
      padding: 2px 8px;
      font-size: 11px;
      box-shadow: none;
    }

    .history-del:hover { transform: none; border-color: #999999; color: #222222; }
    .history-empty { text-align: center; color: var(--muted); font-size: 12px; padding: 10px; }

    .search-row { display: flex; gap: 6px; align-items: center; }

    /* ==================== 存储与背景 ==================== */
    details.secondary {
      border: 1px dashed #c8c8c8;
      padding: 10px 12px;
      background: rgba(247, 250, 255, 0.9);
    }

    details.secondary summary {
      list-style: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    details.secondary summary::-webkit-details-marker { display: none; }

    .file-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* ==================== 排行榜 ==================== */
    .rank-panel { display: grid; gap: 12px; }

    .rank-head { display: grid; gap: 6px; }

    .rank-title { font-size: 34px; font-weight: 700; letter-spacing: -0.02em; }

    .rank-sub { color: var(--muted); font-size: 14px; }

    .rank-board {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.72);
      padding: 14px 14px 12px;
      display: grid;
      gap: 12px;
    }

    .rank-note { color: #555555; font-size: 14px; line-height: 1.5; }

    .rank-legend {
      display: flex;
      gap: 14px;
      align-items: center;
      flex-wrap: wrap;
      color: #555555;
      font-size: 12px;
    }

    .legend-item { display: inline-flex; align-items: center; gap: 6px; }

    .legend-dot {
      width: 12px;
      height: 12px;
      border: 1px solid #777;
    }

    .legend-dot.us { background: #1a1a1a; }
    .legend-dot.cn { background: #8f8f8f; }

    /* ==================== 统计排行榜表格 ==================== */
    .stats-table-container {
      overflow-x: auto;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.72);
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .stats-table th,
    .stats-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--line);
    }

    .stats-table th {
      background: #f7f7f7;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: background 150ms ease;
      position: relative;
    }

    .stats-table th:hover {
      background: #eeeeee;
    }

    .stats-table th.sortable::after {
      content: "↕";
      margin-left: 6px;
      font-size: 12px;
      color: #999;
    }

    .stats-table th.sort-asc::after {
      content: "↑";
      color: var(--ink);
    }

    .stats-table th.sort-desc::after {
      content: "↓";
      color: var(--ink);
    }

    .stats-table td {
      font-family: var(--mono);
    }

    .stats-table tr:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .stats-table .model-name-cell {
      font-family: var(--sans);
      font-weight: 600;
    }

    .stats-table .rank-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: var(--ink);
      color: white;
      font-weight: 700;
      font-size: 12px;
    }

    .stats-table .rank-top3 {
      background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
      color: #333;
    }

    .stats-empty {
      text-align: center;
      color: var(--muted);
      padding: 40px;
      font-size: 14px;
    }

    .rank-bars {
      display: grid;
      grid-template-columns: repeat(9, minmax(78px, 1fr));
      gap: 10px;
      align-items: end;
      min-height: 250px;
      overflow-x: auto;
      padding-bottom: 2px;
    }

    .rank-col {
      min-width: 78px;
      display: grid;
      justify-items: center;
      align-items: end;
      gap: 8px;
    }

    .rank-bar {
      width: 36px;
      background: linear-gradient(180deg, #3a3a3a 0%, #111111 100%);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 12px;
      padding-bottom: 6px;
    }

    .rank-bar.us { background: linear-gradient(180deg, #242424 0%, #0d0d0d 100%); }
    .rank-bar.cn { background: linear-gradient(180deg, #9a9a9a 0%, #616161 100%); }

    .rank-name {
      font-size: 12px;
      line-height: 1.3;
      text-align: center;
      color: #333333;
      min-height: 34px;
      display: grid;
      align-items: start;
    }

    /* ==================== 模态框 ==================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      place-items: center;
      z-index: 1000;
      backdrop-filter: blur(2px);
    }

    .modal-overlay.active { display: grid; }

    .modal {
      background: #fff;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      width: min(420px, 92vw);
      max-height: 85vh;
      overflow: auto;
      display: grid;
      gap: 16px;
      padding: 20px;
    }

    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--line);
    }

    .modal-title { font-size: 17px; font-weight: 700; }

    .modal-close {
      border: none;
      background: none;
      font-size: 22px;
      color: #999;
      cursor: pointer;
      padding: 0;
      box-shadow: none;
    }

    .modal-close:hover { color: #333; }

    .key-form { display: grid; gap: 14px; }
    .key-form label { font-size: 13px; font-weight: 600; color: #333; }

    .key-form input {
      width: 100%;
      border: 1px solid var(--line);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }

    .key-form input:focus { border-color: #888; box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.08); }

    .key-form .btn-row { display: flex; gap: 8px; margin-top: 6px; }
    .key-form button { flex: 1; min-height: 38px; }

    .key-msg {
      padding: 8px 12px;
      font-size: 13px;
      margin-top: 10px;
      display: none;
    }

    .key-msg.show { display: block; }
    .key-msg.success { background: #e8f5e9; color: #2e7d32; }
    .key-msg.error { background: #ffebee; color: #c62828; }

    @media (max-width: 960px) {
      .response-row { height: min(60vh, 620px); }
      .resp-card { width: min(84vw, 430px); }
      .rank-bars { grid-template-columns: repeat(9, minmax(92px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">思辨场</div>
      <button id="keysBtn" class="btn-ghost">密钥</button>
    </header>

    <!-- 密钥模态框 -->
    <div id="keysModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-head">
          <div class="modal-title">API 密钥设置</div>
          <button class="modal-close" id="keysModalClose">&times;</button>
        </div>
        <div class="key-form">
          <label>OpenRouter API Key</label>
          <input type="password" id="keyInput" placeholder="请输入 OpenRouter API Key">
          <div class="btn-row">
            <button id="saveKeyBtn">保存</button>
            <button id="deleteKeyBtn" class="btn-ghost">删除</button>
          </div>
          <div id="keyMsg" class="key-msg"></div>
        </div>
      </div>
    </div>

    <!-- Prompt 输入 -->
    <section class="panel">
      <div class="section-head">
        <h2>Prompt</h2>
        <div class="actions">
          <button id="runBtn">提交</button>
          <button id="exampleBtn" class="btn-ghost">示例</button>
          <button id="clearBtn" class="btn-ghost">清空</button>
        </div>
      </div>
      <textarea id="questionInput" placeholder="例如：写一篇 600 字左右的科幻短篇小说，包含一个意外转折，风格冷峻。"></textarea>
      <div class="mono">回车换行，Command+回车发送</div>
    </section>

    <!-- 模型选择 -->
    <section class="panel">
      <div class="section-head">
        <h2>模型</h2>
        <button id="selectAllBtn" class="btn-ghost">全选/全不选</button>
      </div>
      <div id="modelFilter" class="model-filter"></div>
      <div id="modelGrid" class="model-list"></div>
    </section>

    <!-- 回答展示 -->
    <section class="panel">
      <div class="section-head">
        <h2>回答</h2>
        <div class="actions">
          <button id="genSummaryBtn" class="btn-ghost" style="display:none;">生成差异总结</button>
          <button id="genFusionBtn" class="btn-ghost" style="display:none;">生成最佳融合</button>
        </div>
      </div>
      <div class="mono" id="runMeta">等待</div>
      <div id="responses" class="response-row"></div>
      <div id="summaryPanel" class="summary-panel">
        <div class="summary-card">
          <div class="summary-title">差异总结</div>
          <div id="summaryContent" class="resp-body"></div>
        </div>
        <div class="summary-card">
          <div class="summary-head">
            <div class="summary-title">最佳答案融合</div>
            <button id="regenFusionBtn" class="btn-ghost mini-btn">重新生成</button>
          </div>
          <div id="fusionContent" class="resp-body"></div>
        </div>
      </div>
    </section>

    <!-- 历史记录 -->
    <section class="panel">
      <div class="section-head">
        <h2>记录</h2>
        <div class="search-row">
          <input id="searchHistory" type="search" placeholder="搜索">
          <button id="clearHistory" class="btn-ghost">Clear</button>
        </div>
      </div>
      <div id="historyList" class="history-list"></div>

      <details class="secondary">
        <summary>存储与背景</summary>
        <div class="file-row">
          <span id="fileStatus" class="mono">文件：未绑定</span>
          <button id="bindFileBtn" class="btn-ghost">绑定</button>
          <button id="exportBtn" class="btn-ghost">导出</button>
        </div>
        <div class="file-row">
          <span id="bgStatus" class="mono">背景：默认</span>
          <button id="setBgBtn" class="btn-ghost">设置背景</button>
          <button id="clearBgBtn" class="btn-ghost">清除背景</button>
          <input id="bgInput" type="file" accept="image/*" style="display:none;">
        </div>
      </details>
    </section>

    <!-- 模型排行榜 -->
    <section class="panel rank-panel">
      <div class="rank-head">
        <div class="rank-title">模型排行榜</div>
        <div class="rank-sub">多维度排名，点击表头可切换正序/倒序</div>
      </div>
      <div class="stats-table-container">
        <table class="stats-table" id="statsTable">
          <thead>
            <tr>
              <th data-sort="model">模型</th>
              <th data-sort="speed" class="sortable">平均响应时间</th>
              <th data-sort="cost" class="sortable">平均费用</th>
              <th data-sort="ability" class="sortable">能力指数</th>
              <th data-sort="overall" class="sortable sort-desc">综合排名</th>
            </tr>
          </thead>
          <tbody id="statsTableBody">
            <!-- 动态生成 -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ==================== 配置定义 ====================
    const CONFIG = {
      timeoutMs: 90000,
      gatewayBase: "http://127.0.0.1:8787",
      models: {
        openai: { id: "openai/gpt-5.2", name: "GPT-5.2", region: "美国" },
        anthropic: { id: "anthropic/claude-opus-4.5", name: "Claude Opus 4.5", region: "美国" },
        xai: { id: "x-ai/grok-4", name: "Grok 4", region: "美国" },
        gemini: { id: "google/gemini-3-pro-preview", name: "Gemini 3 Pro Preview", region: "美国" },
        moonshot: { id: "moonshotai/kimi-k2.5", name: "Kimi K2.5", region: "中国" },
        zhipu: { id: "z-ai/glm-5", name: "GLM-5", region: "中国" },
        minimax: { id: "minimax/minimax-m2.5", name: "MiniMax M2.5", region: "中国" },
        qwen: { id: "qwen/qwen3-max-thinking", name: "Qwen3 Max Thinking", region: "中国" },
        deepseek: { id: "deepseek/deepseek-v3.2", name: "DeepSeek V3.2", region: "中国" },
      }
    };

    // 模型能力数据 - key 对应 CONFIG.models 的 key
    const RANKING_DATA = [
      { key: "anthropic", name: "Claude Opus 4.5", score: 53 },
      { key: "openai", name: "GPT-5.2", score: 51 },
      { key: "zhipu", name: "GLM-5", score: 50 },
      { key: "gemini", name: "Gemini 3 Pro Preview", score: 48 },
      { key: "moonshot", name: "Kimi K2.5", score: 47 },
      { key: "minimax", name: "MiniMax M2.5", score: 42 },
      { key: "deepseek", name: "DeepSeek V3.2", score: 42 },
      { key: "xai", name: "Grok 4", score: 41 },
      { key: "qwen", name: "Qwen3 Max Thinking", score: 40 },
    ];

    // ==================== 常量定义 ====================
    const STORAGE_KEY = "multiqa_history_v1";
    const FILE_DB = "multiqa_file_db";
    const FILE_STORE = "handles";
    const BG_KEY = "multiqa_background_v1";
    const OPENROUTER_KEY_STORAGE = "multiqa_openrouter_key";

    // ==================== 状态管理 ====================
    const state = {
      history: [],
      running: false,
      currentRecord: null,
      fileHandle: null
    };

    // ==================== DOM 元素缓存 ====================
    const $ = (id) => document.getElementById(id);
    const elements = {
      questionInput: $("questionInput"),
      runBtn: $("runBtn"),
      clearBtn: $("clearBtn"),
      exampleBtn: $("exampleBtn"),
      modelGrid: $("modelGrid"),
      modelFilter: $("modelFilter"),
      responses: $("responses"),
      runMeta: $("runMeta"),
      historyList: $("historyList"),
      searchHistory: $("searchHistory"),
      clearHistoryBtn: $("clearHistory"),
      selectAllBtn: $("selectAllBtn"),
      fileStatus: $("fileStatus"),
      bindFileBtn: $("bindFileBtn"),
      exportBtn: $("exportBtn"),
      bgStatus: $("bgStatus"),
      setBgBtn: $("setBgBtn"),
      clearBgBtn: $("clearBgBtn"),
      bgInput: $("bgInput"),
      summaryPanel: $("summaryPanel"),
      summaryContent: $("summaryContent"),
      fusionContent: $("fusionContent"),
      regenFusionBtn: $("regenFusionBtn"),
      genSummaryBtn: $("genSummaryBtn"),
      genFusionBtn: $("genFusionBtn"),
      rankBars: $("rankBars"),
      keysModal: $("keysModal"),
      keysBtn: $("keysBtn"),
      keysModalClose: $("keysModalClose"),
      keyInput: $("keyInput"),
      saveKeyBtn: $("saveKeyBtn"),
      deleteKeyBtn: $("deleteKeyBtn"),
      keyMsg: $("keyMsg")
    };

    // ==================== 工具函数 ====================
    const escapeHtml = (text) => {
      return (text || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    };

    const sanitizeText = (text) => (text || "").replace(/[*#]/g, "");

    const setRunMeta = (text) => { elements.runMeta.textContent = text; };

    // ==================== 模型选择器 ====================
    const renderModelSelector = (region = "全部") => {
      const filters = ["全部", "中国", "美国"];
      const current = filters.includes(region) ? region : "全部";

      elements.modelFilter.innerHTML = filters.map(name =>
        `<button type="button" class="filter-btn ${name === current ? "active" : ""}" data-region="${name}">${name}</button>`
      ).join("");

      const modelEntries = Object.entries(CONFIG.models);
      const list = current === "全部"
        ? modelEntries
        : modelEntries.filter(([, cfg]) => cfg.region === current);

      // 排序：MiniMax 和 GLM 靠后
      const sortedList = list.sort((a, b) => {
        const weight = (key) => ({ minimax: 10, zhipu: 20 }[key] || 0);
        return weight(a[0]) - weight(b[0]);
      });

      elements.modelGrid.innerHTML = sortedList.map(([key, cfg]) => `
        <label class="model-item">
          <input class="model-check" type="checkbox" name="model" value="${key}">
          <div>
            <div class="model-name">${cfg.name}</div>
          </div>
        </label>
      `).join("");

      elements.modelFilter.querySelectorAll(".filter-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const selected = btn.dataset.region;
          const checked = new Set(Array.from(document.querySelectorAll("input[name='model']:checked")).map(el => el.value));
          renderModelSelector(selected);
          document.querySelectorAll("input[name='model']").forEach(box => { box.checked = checked.has(box.value); });
        });
      });
    };

    // ==================== 统计排行榜 ====================
    const calculateModelStats = () => {
      const stats = {};

      Object.keys(CONFIG.models).forEach(key => {
        stats[key] = {
          key,
          name: CONFIG.models[key].name,
          totalDuration: 0,
          totalCost: 0,
          count: 0
        };
      });

      state.history.forEach(record => {
        if (record.responses) {
          record.responses.forEach(resp => {
            if (resp.modelKey && stats[resp.modelKey] && !resp.error) {
              stats[resp.modelKey].totalDuration += resp.durationMs || 0;
              // 累加费用（cost 单位是美元）
              if (resp.usage && resp.usage.cost !== undefined) {
                stats[resp.modelKey].totalCost += resp.usage.cost;
              }
              stats[resp.modelKey].count++;
            }
          });
        }
      });

      return Object.values(stats).map(s => ({
        ...s,
        avgDuration: s.count > 0 ? Math.round(s.totalDuration / s.count) : null,
        avgCost: s.count > 0 ? (s.totalCost / s.count) : null
      }));
    };

    const calculateRankings = (models) => {
      // 按速度排序（时间短排前）
      const speedSorted = [...models]
        .filter(m => m.avgDuration !== null)
        .sort((a, b) => {
          if (a.avgDuration !== b.avgDuration) return a.avgDuration - b.avgDuration;
          return a.name.localeCompare(b.name);
        });

      // 按费用排序（费用少排前）
      const costSorted = [...models]
        .filter(m => m.avgCost !== null)
        .sort((a, b) => {
          if (a.avgCost !== b.avgCost) return a.avgCost - b.avgCost;
          return a.name.localeCompare(b.name);
        });

      // 按能力排序（分数高排前）
      const abilitySorted = [...RANKING_DATA].sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return a.name.localeCompare(b.name);
      });

      // 构建排名映射
      const speedRank = {};
      speedSorted.forEach((m, i) => { speedRank[m.key] = i + 1; });

      const costRank = {};
      costSorted.forEach((m, i) => { costRank[m.key] = i + 1; });

      const abilityRank = {};
      abilitySorted.forEach((item, i) => {
        // 直接使用 RANKING_DATA 中的 key 进行匹配
        if (item.key) abilityRank[item.key] = i + 1;
      });

      // 构建能力分数映射
      const abilityScore = {};
      RANKING_DATA.forEach(item => {
        if (item.key) abilityScore[item.key] = item.score;
      });

      // 计算综合排名（三个单项排名的平均值）
      return models.map(m => {
        const sRank = speedRank[m.key] || models.length;
        const cRank = costRank[m.key] || models.length;
        const aRank = abilityRank[m.key] || models.length;
        const aScore = abilityScore[m.key] || 0;

        // 综合排名 = (速度排名 + 费用排名 + 能力排名) / 3
        const overallRank = (sRank + cRank + aRank) / 3;

        return {
          ...m,
          speedRank: sRank,
          costRank: cRank,
          abilityRank: aRank,
          abilityScore: aScore,
          overallRank: overallRank
        };
      });
    };

    const renderStatsTable = (sortBy = "overall", sortOrder = "asc") => {
      const tbody = document.getElementById("statsTableBody");
      const models = calculateModelStats();

      if (models.every(m => m.count === 0)) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="stats-empty">
              暂无问答记录，开始提问后将自动统计
            </td>
          </tr>
        `;
        return;
      }

      const rankedModels = calculateRankings(models);

      // 排序
      rankedModels.sort((a, b) => {
        let comparison = 0;

        switch (sortBy) {
          case "model":
            comparison = a.name.localeCompare(b.name);
            break;
          case "speed":
            if (a.avgDuration === null && b.avgDuration === null) comparison = 0;
            else if (a.avgDuration === null) comparison = 1;
            else if (b.avgDuration === null) comparison = -1;
            else comparison = a.avgDuration - b.avgDuration;
            break;
          case "cost":
            if (a.avgCost === null && b.avgCost === null) comparison = 0;
            else if (a.avgCost === null) comparison = 1;
            else if (b.avgCost === null) comparison = -1;
            else comparison = a.avgCost - b.avgCost;
            break;
          case "ability":
            comparison = b.abilityScore - a.abilityScore;
            break;
          case "overall":
            comparison = a.overallRank - b.overallRank;
            break;
        }

        if (comparison === 0) {
          comparison = a.name.localeCompare(b.name);
        }

        // 平局时随机排序
        if (comparison === 0) {
          comparison = Math.random() - 0.5;
        }

        return sortOrder === "asc" ? comparison : -comparison;
      });

      tbody.innerHTML = rankedModels.map((m) => {
        const speedText = m.avgDuration !== null 
          ? `${m.avgDuration}ms <span style="color:#999;font-size:11px">(第${m.speedRank}名)</span>` 
          : "-";
        const costText = m.avgCost !== null 
          ? `$${m.avgCost.toFixed(4)} <span style="color:#999;font-size:11px">(第${m.costRank}名)</span>` 
          : "-";
        // 综合排名显示计算值（如 1.33），纯数字无样式
        const overallText = m.overallRank.toFixed(2);
        return `
          <tr>
            <td class="model-name-cell">${escapeHtml(m.name)}</td>
            <td>${speedText}</td>
            <td>${costText}</td>
            <td>${m.abilityScore} <span style="color:#999;font-size:11px">(第${m.abilityRank}名)</span></td>
            <td>${overallText}</td>
          </tr>
        `;
      }).join("");

      // 更新表头排序状态
      document.querySelectorAll(".stats-table th").forEach(th => {
        th.classList.remove("sort-asc", "sort-desc");
        if (th.dataset.sort === sortBy) {
          th.classList.add(sortOrder === "asc" ? "sort-asc" : "sort-desc");
        }
      });
    };

    // 绑定表头点击事件
    const bindStatsTableSort = () => {
      let currentSort = "overall";
      let currentOrder = "asc";

      document.querySelectorAll(".stats-table th[data-sort]").forEach(th => {
        th.addEventListener("click", () => {
          const sortBy = th.dataset.sort;

          if (sortBy === currentSort) {
            currentOrder = currentOrder === "asc" ? "desc" : "asc";
          } else {
            currentSort = sortBy;
            currentOrder = "asc";
          }

          renderStatsTable(currentSort, currentOrder);
        });
      });
    };

    // ==================== 历史记录 ====================
    const loadHistory = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        state.history = raw ? JSON.parse(raw) : [];
      } catch {
        state.history = [];
      }
      renderHistory(state.history);
    };

    const saveHistory = () => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history.slice(0, 200)));
    };

    const renderHistory = (list) => {
      if (!list.length) {
        elements.historyList.innerHTML = '<div class="history-empty">暂无</div>';
        return;
      }

      elements.historyList.innerHTML = list.map(item => {
        const time = new Date(item.createdAt).toLocaleString();
        const preview = (item.query || "").slice(0, 70);
        const badge = item.models.join(", ");
        return `
          <div class="history-item" data-id="${item.id}">
            <div class="history-top">
              <div class="time">${time}</div>
              <button class="history-del" data-del-id="${item.id}" type="button">删除</button>
            </div>
            <div class="question">${escapeHtml(preview)}</div>
            <div class="mono">${badge}</div>
          </div>
        `;
      }).join("");

      elements.historyList.querySelectorAll(".history-item").forEach(el => {
        el.addEventListener("click", () => {
          const record = state.history.find(h => h.id === el.dataset.id);
          if (!record) return;
          state.currentRecord = record;
          elements.questionInput.value = record.query;
          renderRecord(record, false);
          renderSummaryFromSaved(record.summary);
          renderFusionFromSaved(record.fusion);
        });
      });

      elements.historyList.querySelectorAll(".history-del").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          deleteHistoryRecord(btn.dataset.delId);
        });
      });
    };

    const deleteHistoryRecord = (id) => {
      if (!id) return;
      state.history = state.history.filter(item => item.id !== id);
      if (state.currentRecord?.id === id) clearResponses();
      saveHistory();
      renderStatsTable();
      filterHistory(elements.searchHistory.value.trim());
    };

    const filterHistory = (keyword) => {
      if (!keyword) return renderHistory(state.history);
      const lower = keyword.toLowerCase();
      const filtered = state.history.filter(item =>
        item.query.toLowerCase().includes(lower) ||
        (item.responses || []).some(r => (r.content || "").toLowerCase().includes(lower))
      );
      renderHistory(filtered);
    };

    const clearHistory = () => {
      if (!confirm("确认清空所有本地记录？")) return;
      state.history = [];
      saveHistory();
      renderHistory([]);
      clearResponses();
    };

    // ==================== 响应卡片 ====================
    const buildCard = (modelKey) => {
      const cfg = CONFIG.models[modelKey];
      return `
        <div class="resp-card" id="card-${modelKey}" data-model-key="${modelKey}">
          <div class="resp-head">
            <div class="resp-title">${cfg.name}</div>
            <div class="resp-tools">
              <button class="order-btn" data-move="left" title="左移">←</button>
              <button class="order-btn" data-move="right" title="右移">→</button>
              <button class="copy-btn" style="display:none;">复制</button>
              <div class="status">请求中</div>
            </div>
          </div>
          <div class="resp-meta" style="font-family: var(--mono); font-size: 11px; color: var(--muted);"></div>
          <div class="resp-body"></div>
        </div>
      `;
    };

    const bindCardButtons = () => {
      elements.responses.querySelectorAll(".order-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const card = btn.closest(".resp-card");
          if (!card) return;
          if (btn.dataset.move === "left" && card.previousElementSibling) {
            elements.responses.insertBefore(card, card.previousElementSibling);
          } else if (btn.dataset.move === "right" && card.nextElementSibling) {
            elements.responses.insertBefore(card.nextElementSibling, card);
          }
        });
      });

      elements.responses.querySelectorAll(".copy-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const text = btn.closest(".resp-card")?.querySelector(".resp-body")?.textContent || "";
          try {
            await navigator.clipboard.writeText(text);
            btn.textContent = "已复制";
            btn.classList.add("copied");
            setTimeout(() => { btn.textContent = "复制"; btn.classList.remove("copied"); }, 2000);
          } catch {
            btn.textContent = "复制失败";
            setTimeout(() => { btn.textContent = "复制"; }, 2000);
          }
        });
      });
    };

    const renderRecord = (record, withMeta = true) => {
      elements.responses.innerHTML = record.responses.map(resp => {
        const cfg = CONFIG.models[resp.modelKey];
        const statusClass = resp.error ? "err" : "ok";
        const bodyText = sanitizeText(resp.error || resp.content || "(空响应)");
        // 显示费用、token、时间信息
        let metaText = `${resp.durationMs} ms`;
        if (resp.usage && !resp.error) {
          const cost = resp.usage.cost !== undefined ? `$${resp.usage.cost.toFixed(4)}` : '-';
          const tokens = resp.usage.total_tokens || 0;
          metaText = `${cost} | ${tokens} tokens | ${resp.durationMs} ms`;
        }
        return `
          <div class="resp-card" id="card-${resp.modelKey}" data-model-key="${resp.modelKey}">
            <div class="resp-head">
              <div class="resp-title">${cfg.name}</div>
              <div class="resp-tools">
                <button class="order-btn" data-move="left">←</button>
                <button class="order-btn" data-move="right">→</button>
                <button class="copy-btn" ${resp.error ? 'style="display:none;"' : ''}>复制</button>
                <div class="status ${statusClass}" ${!resp.error ? 'style="display:none;"' : ''}>失败</div>
              </div>
            </div>
            <div class="resp-meta" style="font-family: var(--mono); font-size: 11px; color: var(--muted);">${metaText}</div>
            <div class="resp-body">${escapeHtml(bodyText)}</div>
          </div>
        `;
      }).join("");
      bindCardButtons();
      if (withMeta) {
        setRunMeta(`${record.models.length} 个模型 | ${new Date(record.createdAt).toLocaleString()}`);
      }
    };

    const clearResponses = () => {
      elements.responses.innerHTML = "";
      elements.summaryPanel.style.display = "none";
      elements.fusionContent.textContent = "";
      elements.genSummaryBtn.style.display = "none";
      elements.genFusionBtn.style.display = "none";
      setRunMeta("等待");
      state.currentRecord = null;
    };

    // ==================== 流式渲染器 ====================
    const createStreamRenderer = (el) => {
      el.textContent = "";
      const node = document.createTextNode("");
      el.appendChild(node);

      let fullText = "";
      let renderBuffer = "";
      let deltaBuffer = "";
      let frameId = 0;
      let timerId = 0;

      const shouldFlush = (text) => text.length >= 8 || /[，。！？；：、\n\r ]$/.test(text);

      const flush = () => {
        frameId = 0;
        if (!renderBuffer) return;
        node.appendData(renderBuffer);
        renderBuffer = "";
      };

      const scheduleFlush = () => { if (!frameId) frameId = requestAnimationFrame(flush); };

      return {
        push(delta) {
          if (!delta) return;
          const safe = sanitizeText(delta);
          if (!safe) return;
          fullText += safe;
          deltaBuffer += safe;

          if (shouldFlush(deltaBuffer)) {
            renderBuffer += deltaBuffer;
            deltaBuffer = "";
            scheduleFlush();
            if (timerId) { clearTimeout(timerId); timerId = 0; }
            return;
          }

          if (!timerId) {
            timerId = setTimeout(() => {
              timerId = 0;
              if (deltaBuffer) { renderBuffer += deltaBuffer; deltaBuffer = ""; scheduleFlush(); }
            }, 36);
          }
        },
        set(text) {
          if (frameId) cancelAnimationFrame(frameId);
          if (timerId) clearTimeout(timerId);
          frameId = timerId = 0;
          fullText = sanitizeText(text || "");
          renderBuffer = deltaBuffer = "";
          node.data = fullText;
        },
        get: () => fullText
      };
    };

    // ==================== API 调用 ====================
    const normalizeError = (error) => {
      if (!error) return "请求失败";
      if (error.name === "AbortError") return "请求超时";
      if (String(error.message).includes("Failed to fetch")) return "网络或 CORS 被阻止";
      return error.message || "请求失败";
    };

    // 竞赛提醒前缀 - 自动添加到每次问答中（不显示在前端）
    const COMPETITION_REMINDER = "【系统提示】你正在参加一场大模型能力评估。请根据问题的性质，提供最适合、最精准的回答——简洁问题时言简意赅，复杂问题时深入详尽。你的表现将被评估和比较。\n\n用户问题：";

    const callModel = async (modelKey, prompt, onStream) => {
      // 在prompt前添加竞赛提醒（用户不可见）
      const enhancedPrompt = COMPETITION_REMINDER + prompt;
      const messages = [{ role: "user", content: enhancedPrompt }];
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), CONFIG.timeoutMs);
      const started = performance.now();

      const url = `${CONFIG.gatewayBase}/api/${modelKey}/chat/completions`;
      // 后端会自动从 .api_key 文件读取密钥，前端无需传递

      const body = {
        model: CONFIG.models[modelKey].id,
        messages,
        temperature: ["zhipu", "minimax"].includes(modelKey) ? 1.0 : 0.6
      };

      const shouldRetry = (msg) => /HTTP 5\d\d|timeout|超时|temporar|network|CORS|429|rate limit|busy/i.test(String(msg));

      try {
        for (let attempt = 1; attempt <= 3; attempt++) {
          try {
            const res = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ...body, stream: true }),
              signal: controller.signal
            });

            if (!res.ok) {
              let payload = null, text = "";
              try { payload = await res.json(); } catch {}
              if (!payload) try { text = await res.text(); } catch {}
              throw new Error(payload?.error?.message || payload?.message || text || `HTTP ${res.status}`);
            }

            if (!res.body) {
              const payload = await res.json();
              const content = payload?.choices?.[0]?.message?.content?.trim() || "";
              return { ok: true, content: sanitizeText(content), durationMs: Math.round(performance.now() - started) };
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let content = "";
            let usage = null;

            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              const chunk = decoder.decode(value, { stream: true });

              for (const line of chunk.split(/\r?\n/)) {
                const trimmed = line.trim();
                if (!trimmed.startsWith("data:")) continue;
                const data = trimmed.slice(5).trim();
                if (!data || data === "[DONE]") continue;
                try {
                  const json = JSON.parse(data);
                  const delta = json?.choices?.[0]?.delta?.content || "";
                  // 捕获 usage 信息（费用、token等）
                  if (json?.usage) {
                    usage = json.usage;
                  }
                  if (delta) { content += delta; onStream?.(delta, content); }
                } catch {}
              }
            }

            return { 
              ok: true, 
              content: sanitizeText(content), 
              durationMs: Math.round(performance.now() - started),
              usage: usage
            };
          } catch (error) {
            if (attempt < 3 && shouldRetry(error.message)) {
              await new Promise(r => setTimeout(r, 420));
              continue;
            }
            throw error;
          }
        }
        throw new Error("请求失败");
      } catch (error) {
        return { ok: false, error: normalizeError(error), durationMs: Math.round(performance.now() - started) };
      } finally {
        clearTimeout(timer);
      }
    };

    // ==================== 差异总结与融合 ====================
    const renderSummaryFromText = (text) => { elements.summaryContent.textContent = sanitizeText(text || "").trim() || "生成中..."; };
    const renderFusionFromText = (text) => { elements.fusionContent.textContent = sanitizeText(text || "").trim() || "生成中..."; };

    const renderSummaryFromSaved = (text) => {
      if (!text) { elements.summaryPanel.style.display = "none"; return; }
      elements.summaryPanel.style.display = "grid";
      renderSummaryFromText(typeof text === "object" ? (text.diff || text.raw || "") : text);
    };

    const renderFusionFromSaved = (text) => {
      if (!text) { renderFusionFromText(""); return; }
      elements.summaryPanel.style.display = "grid";
      renderFusionFromText(text);
    };

    const generateSummary = async (record) => {
      elements.summaryPanel.style.display = "grid";
      renderSummaryFromText("生成中...");

      const promptLines = [
        "你是严谨的对比分析助手。",
        "请基于以下多模型回答，生成一段差异总结，强调风格、结构、信息密度和完成度差异。",
        "只输出纯文本，不要使用星号，不要使用井号，不要用列表标记。",
        "问题：" + record.query,
        "回答："
      ];

      record.responses.forEach(resp => {
        const cfg = CONFIG.models[resp.modelKey];
        promptLines.push(`【${cfg.name}】`, resp.content || resp.error || "");
      });

      let raw = "";
      const result = await callModel("qwen", promptLines.join("\n"), (delta, full) => { raw = full; renderSummaryFromText(raw); });

      if (!result.ok) {
        renderSummaryFromText(result.error || "生成失败");
        return result.error || "生成失败";
      }

      raw = sanitizeText(raw || result.content || "");
      renderSummaryFromText(raw);
      return raw || "-";
    };

    const generateFusion = async (record) => {
      elements.summaryPanel.style.display = "grid";
      renderFusionFromText("生成中...");

      const promptLines = [
        "你是资深编辑与答案整合助手。",
        "请融合以下多个答案，生成一个最终版。",
        "要求：结构清晰，可直接执行，避免重复，补齐遗漏，保留关键信息。",
        "输出限制：只输出最终答案正文，不要解释过程，不要提及模型，不要出现星号和井号。",
        "用户问题：" + record.query,
        "候选答案："
      ];

      record.responses.forEach(resp => {
        const cfg = CONFIG.models[resp.modelKey];
        promptLines.push(`【${cfg.name}】`, resp.content || resp.error || "");
      });

      let raw = "";
      const result = await callModel("qwen", promptLines.join("\n"), (delta, full) => { raw = full; renderFusionFromText(raw); });

      if (!result.ok) {
        renderFusionFromText(result.error || "生成失败");
        return result.error || "生成失败";
      }

      raw = sanitizeText(raw || result.content || "");
      renderFusionFromText(raw);
      return raw || "-";
    };

    const regenerateFusion = async () => {
      if (state.running || !state.currentRecord) return;
      elements.regenFusionBtn.disabled = true;
      const fusion = await generateFusion(state.currentRecord);
      state.currentRecord.fusion = fusion;
      const idx = state.history.findIndex(item => item.id === state.currentRecord.id);
      if (idx >= 0) state.history[idx].fusion = fusion;
      saveHistory();
      elements.regenFusionBtn.disabled = false;
    };

    // ==================== 主流程 ====================
    const runQuery = async () => {
      const prompt = elements.questionInput.value.trim();
      if (!prompt) { elements.questionInput.focus(); return; }

      const selected = Array.from(document.querySelectorAll("input[name='model']:checked")).map(el => el.value);
      if (!selected.length) { alert("请至少选择一个模型"); return; }

      // 排序：MiniMax 和 GLM 靠后
      const sorted = [...selected].sort((a, b) => {
        const weight = (key) => ({ minimax: 10, zhipu: 20 }[key] || 0);
        return weight(a) - weight(b);
      });

      state.running = true;
      elements.runBtn.disabled = true;
      elements.regenFusionBtn.disabled = true;
      setRunMeta(`执行中 | ${selected.length} 个模型`);
      elements.responses.innerHTML = sorted.map(key => buildCard(key)).join("");
      bindCardButtons();
      elements.summaryPanel.style.display = "none";
      elements.fusionContent.textContent = "";

      const tasks = sorted.map(async (modelKey) => {
        try {
          const card = document.getElementById(`card-${modelKey}`);
          const renderer = createStreamRenderer(card.querySelector(".resp-body"));
          const result = await callModel(modelKey, prompt, (delta) => renderer.push(delta));

          const cfg = CONFIG.models[modelKey];
          
          // 显示费用、token、时间信息
          let metaText = `${result.durationMs} ms`;
          if (result.ok && result.usage) {
            const cost = result.usage.cost !== undefined ? `$${result.usage.cost.toFixed(4)}` : '-';
            const tokens = result.usage.total_tokens || 0;
            metaText = `${cost} | ${tokens} tokens | ${result.durationMs} ms`;
          }
          card.querySelector(".resp-meta").textContent = metaText;

          if (result.ok) {
            card.querySelector(".status").style.display = "none";
            card.querySelector(".copy-btn").style.display = "inline-flex";
            if (!renderer.get()) renderer.set(result.content || "(空响应)");
          } else {
            card.querySelector(".status").textContent = "失败";
            card.querySelector(".status").className = "status err";
            renderer.set(result.error || "请求失败");
          }

          return {
            modelKey,
            modelName: cfg.id,
            content: result.content || renderer.get(),
            error: result.ok ? null : result.error,
            durationMs: result.durationMs,
            usage: result.usage,
            finishedAt: new Date().toISOString()
          };
        } catch (error) {
          return {
            modelKey,
            modelName: CONFIG.models[modelKey].id,
            content: "",
            error: normalizeError(error),
            durationMs: 0,
            finishedAt: new Date().toISOString()
          };
        }
      });

      const settled = await Promise.allSettled(tasks);
      const responses = settled.map((item, index) =>
        item.status === "fulfilled" ? item.value : {
          modelKey: sorted[index],
          modelName: CONFIG.models[sorted[index]].id,
          content: "",
          error: normalizeError(item.reason),
          durationMs: 0,
          usage: null,
          finishedAt: new Date().toISOString()
        }
      );

      const record = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
        createdAt: new Date().toISOString(),
        query: prompt,
        models: sorted.map(k => CONFIG.models[k].name),
        modelKeys: sorted,
        responses,
        summary: null,
        fusion: null
      };

      state.history.unshift(record);
      saveHistory();
      renderHistory(state.history);
      renderStatsTable();
      state.currentRecord = record;
      setRunMeta(`${selected.length} 个模型 | ${new Date(record.createdAt).toLocaleString()}`);
      state.running = false;
      elements.runBtn.disabled = false;
      elements.genSummaryBtn.style.display = "inline-flex";
      elements.genFusionBtn.style.display = "inline-flex";

      await appendToFile(record);
    };

    // ==================== 文件操作 ====================
    const openDb = () => new Promise((resolve, reject) => {
      const request = indexedDB.open(FILE_DB, 1);
      request.onupgradeneeded = () => {
        const db = request.result;
        if (!db.objectStoreNames.contains(FILE_STORE)) db.createObjectStore(FILE_STORE);
      };
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });

    const idbSet = async (key, value) => {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(FILE_STORE, "readwrite");
        tx.objectStore(FILE_STORE).put(value, key);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    };

    const idbGet = async (key) => {
      const db = await openDb();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(FILE_STORE, "readonly");
        const req = tx.objectStore(FILE_STORE).get(key);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    };

    const loadFileHandle = async () => {
      if (!window.showSaveFilePicker) {
        elements.fileStatus.textContent = "文件：浏览器不支持";
        elements.bindFileBtn.disabled = true;
        return;
      }
      try {
        const handle = await idbGet("historyFile");
        if (handle) { state.fileHandle = handle; elements.fileStatus.textContent = `文件：${handle.name}`; }
      } catch {
        elements.fileStatus.textContent = "文件：读取失败";
      }
    };

    const bindFile = async () => {
      if (!window.showSaveFilePicker) return;
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: "multiqa_history.jsonl",
          types: [{ description: "JSON Lines", accept: { "application/json": [".jsonl", ".json"] } }]
        });
        state.fileHandle = handle;
        await idbSet("historyFile", handle);
        elements.fileStatus.textContent = `文件：${handle.name}`;
      } catch {
        elements.fileStatus.textContent = "文件：未绑定";
      }
    };

    const ensureWritePermission = async () => {
      if (!state.fileHandle) return false;
      if (state.fileHandle.queryPermission) {
        const status = await state.fileHandle.queryPermission({ mode: "readwrite" });
        if (status === "granted") return true;
      }
      if (state.fileHandle.requestPermission) {
        return (await state.fileHandle.requestPermission({ mode: "readwrite" })) === "granted";
      }
      return false;
    };

    const appendToFile = async (record) => {
      if (!state.fileHandle) return;
      if (!(await ensureWritePermission())) { elements.fileStatus.textContent = "文件：无写入权限"; return; }
      try {
        const file = await state.fileHandle.getFile();
        const writable = await state.fileHandle.createWritable({ keepExistingData: true });
        await writable.write({ type: "write", position: file.size, data: JSON.stringify(record) + "\n" });
        await writable.close();
      } catch {
        elements.fileStatus.textContent = "文件：写入失败";
      }
    };

    const exportOnce = () => {
      const blob = new Blob([JSON.stringify(state.history, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "multiqa_history.json";
      a.click();
      URL.revokeObjectURL(url);
    };

    // ==================== 背景设置 ====================
    const applyBackground = (dataUrl) => {
      document.documentElement.style.setProperty("--bg-image", dataUrl ? `url("${dataUrl}")` : "none");
      elements.bgStatus.textContent = dataUrl ? "背景：已设置" : "背景：默认";
    };

    const loadBackground = () => {
      try { applyBackground(localStorage.getItem(BG_KEY)); } catch { applyBackground(""); }
    };

    const setBackground = (file) => {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try { localStorage.setItem(BG_KEY, reader.result); applyBackground(reader.result); } catch {
          elements.bgStatus.textContent = "背景：保存失败";
        }
      };
      reader.readAsDataURL(file);
    };

    const clearBackground = () => {
      localStorage.removeItem(BG_KEY);
      applyBackground("");
      elements.bgInput.value = "";
    };

    // ==================== 密钥管理（保存到本地文件）====================
    const loadKeyFromFile = async () => {
      try {
        const res = await fetch(`${CONFIG.gatewayBase}/api/key`);
        const data = await res.json();
        return data;
      } catch (e) {
        return { has_key: false, masked_key: "****" };
      }
    };

    const openKeysModal = async () => {
      elements.keysModal.classList.add("active");
      // 加载当前密钥状态
      const keyInfo = await loadKeyFromFile();
      const statusText = keyInfo.has_key
        ? `当前密钥: ${keyInfo.masked_key}`
        : "当前使用默认密钥（可能已失效）";
      elements.keyMsg.className = "key-msg show";
      elements.keyMsg.textContent = statusText;
    };

    const closeKeysModal = () => {
      elements.keysModal.classList.remove("active");
      elements.keyMsg.className = "key-msg";
      elements.keyMsg.textContent = "";
    };

    const saveKey = async () => {
      const key = elements.keyInput.value.trim();
      if (!key) {
        elements.keyMsg.className = "key-msg show error";
        elements.keyMsg.textContent = "请输入 API Key";
        return;
      }

      try {
        const res = await fetch(`${CONFIG.gatewayBase}/api/key`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ key })
        });

        const data = await res.json();
        if (res.ok) {
          elements.keyMsg.className = "key-msg show success";
          elements.keyMsg.textContent = "已保存到本地文件 api_key.txt";
          elements.keyInput.value = "";
          // 3秒后自动关闭
          setTimeout(closeKeysModal, 2000);
        } else {
          elements.keyMsg.className = "key-msg show error";
          elements.keyMsg.textContent = data.detail || "保存失败";
        }
      } catch (e) {
        elements.keyMsg.className = "key-msg show error";
        elements.keyMsg.textContent = "网络错误，保存失败";
      }
    };

    const deleteKey = async () => {
      if (!confirm("确定删除本地保存的 API Key 吗？将恢复使用默认密钥。")) return;

      try {
        const res = await fetch(`${CONFIG.gatewayBase}/api/key`, { method: "DELETE" });
        if (res.ok) {
          elements.keyMsg.className = "key-msg show success";
          elements.keyMsg.textContent = "已删除，恢复使用默认密钥";
          setTimeout(closeKeysModal, 2000);
        } else {
          elements.keyMsg.className = "key-msg show error";
          elements.keyMsg.textContent = "删除失败";
        }
      } catch (e) {
        elements.keyMsg.className = "key-msg show error";
        elements.keyMsg.textContent = "网络错误";
      }
    };

    // ==================== 事件绑定 ====================
    elements.keysBtn.addEventListener("click", openKeysModal);
    elements.keysModalClose.addEventListener("click", closeKeysModal);
    elements.keysModal.addEventListener("click", (e) => { if (e.target === elements.keysModal) closeKeysModal(); });
    elements.saveKeyBtn.addEventListener("click", saveKey);
    elements.deleteKeyBtn.addEventListener("click", deleteKey);
    elements.runBtn.addEventListener("click", () => { if (!state.running) runQuery(); });
    elements.clearBtn.addEventListener("click", clearResponses);
    elements.clearHistoryBtn.addEventListener("click", clearHistory);
    elements.searchHistory.addEventListener("input", (e) => filterHistory(e.target.value.trim()));
    elements.selectAllBtn.addEventListener("click", () => {
      const boxes = Array.from(document.querySelectorAll("input[name='model']"));
      const allChecked = boxes.every(box => box.checked);
      boxes.forEach(box => { box.checked = !allChecked; });
    });
    elements.exampleBtn.addEventListener("click", () => {
      elements.questionInput.value = "写一篇 600 字左右的科幻短篇小说，包含一个意外转折，风格冷峻。";
      elements.questionInput.focus();
    });
    elements.bindFileBtn.addEventListener("click", bindFile);
    elements.exportBtn.addEventListener("click", exportOnce);
    elements.regenFusionBtn.addEventListener("click", regenerateFusion);
    elements.genSummaryBtn.addEventListener("click", async () => {
      if (!state.currentRecord) return;
      elements.genSummaryBtn.disabled = true;
      elements.genSummaryBtn.textContent = "生成中...";
      state.currentRecord.summary = await generateSummary(state.currentRecord);
      saveHistory();
      elements.summaryPanel.style.display = "grid";
      elements.genSummaryBtn.style.display = "none";
    });
    elements.genFusionBtn.addEventListener("click", async () => {
      if (!state.currentRecord) return;
      elements.genFusionBtn.disabled = true;
      elements.genFusionBtn.textContent = "生成中...";
      state.currentRecord.fusion = await generateFusion(state.currentRecord);
      saveHistory();
      elements.summaryPanel.style.display = "grid";
      elements.genFusionBtn.style.display = "none";
    });
    elements.setBgBtn.addEventListener("click", () => elements.bgInput.click());
    elements.clearBgBtn.addEventListener("click", clearBackground);
    elements.bgInput.addEventListener("change", () => setBackground(elements.bgInput.files?.[0]));
    elements.questionInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) { e.preventDefault(); elements.runBtn.click(); }
    });

    elements.questionInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        elements.runBtn.click();
      }
    });

    // ==================== 初始化 ====================
    renderModelSelector();
    loadHistory();
    renderStatsTable();
    bindStatsTableSort();
    loadFileHandle();
    loadBackground();
  </script>
</body>
</html>
  </script>
</body>
</html>
